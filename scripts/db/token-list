#!/usr/bin/env bash
set -euo pipefail

if [ -z "${COURIER_DATABASE_URL:-}" ]; then
  echo "Error: COURIER_DATABASE_URL environment variable is not set" >&2
  exit 1
fi

# Optional: filter by account ID
if [ $# -eq 1 ]; then
  ACCOUNT_ID="$1"
  if ! [[ "$ACCOUNT_ID" =~ ^[0-9]+$ ]]; then
    echo "Error: Account ID must be a number" >&2
    exit 1
  fi
  if ! RESULT=$(echo "SELECT k.id, k.account_id, a.email, k.created_at, k.accessed_at, k.revoked_at FROM api_key k JOIN account a ON k.account_id = a.id WHERE k.account_id = :account_id ORDER BY k.id;" | psql "$COURIER_DATABASE_URL" -v account_id="$ACCOUNT_ID" 2>&1); then
    echo "Error: Failed to list API tokens" >&2
    echo "$RESULT" >&2
    exit 1
  fi
else
  if ! RESULT=$(echo "SELECT k.id, k.account_id, a.email, k.created_at, k.accessed_at, k.revoked_at FROM api_key k JOIN account a ON k.account_id = a.id ORDER BY k.id;" | psql "$COURIER_DATABASE_URL" 2>&1); then
    echo "Error: Failed to list API tokens" >&2
    echo "$RESULT" >&2
    exit 1
  fi
fi

echo "$RESULT"
