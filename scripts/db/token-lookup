#!/usr/bin/env bash
set -euo pipefail

if [ -z "${COURIER_DATABASE_URL:-}" ]; then
  echo "Error: COURIER_DATABASE_URL environment variable is not set" >&2
  exit 1
fi

if [ $# -ne 1 ]; then
  echo "Usage: $0 <plaintext-token>" >&2
  echo "Look up API token information by plaintext token value" >&2
  exit 1
fi

TOKEN="$1"

# Hash the token using SHA-256 and convert to bytea format
TOKEN_HASH=$(echo -n "$TOKEN" | openssl dgst -sha256 -binary | xxd -p -c 256)

if ! RESULT=$(echo "SELECT k.id, k.account_id, a.email, a.organization_id, o.name as org_name, k.created_at, k.accessed_at, k.revoked_at FROM api_key k JOIN account a ON k.account_id = a.id JOIN organization o ON a.organization_id = o.id WHERE k.hash = :'token_hash';" | psql "$COURIER_DATABASE_URL" -v token_hash="\\x$TOKEN_HASH" 2>&1); then
  echo "Error: Failed to lookup API token" >&2
  echo "$RESULT" >&2
  exit 1
fi

if echo "$RESULT" | grep -q "(0 rows)"; then
  echo "Error: Token not found" >&2
  exit 1
fi

echo "$RESULT"
