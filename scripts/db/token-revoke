#!/usr/bin/env bash
set -euo pipefail

if [ -z "${COURIER_DATABASE_URL:-}" ]; then
  echo "Error: COURIER_DATABASE_URL environment variable is not set" >&2
  exit 1
fi

if [ $# -ne 1 ]; then
  echo "Usage: $0 <token-id-or-plaintext-token>" >&2
  echo "Revoke an API token by ID or plaintext token value" >&2
  exit 1
fi

TOKEN_INPUT="$1"

# Check if input is a numeric ID or plaintext token
if [[ "$TOKEN_INPUT" =~ ^[0-9]+$ ]]; then
  # Input is a token ID
  if ! RESULT=$(echo "UPDATE api_key SET revoked_at = NOW() WHERE id = :token_id AND revoked_at IS NULL RETURNING id, account_id, revoked_at;" | psql "$COURIER_DATABASE_URL" -v token_id="$TOKEN_INPUT" -t 2>&1); then
    echo "Error: Failed to revoke API token" >&2
    echo "$RESULT" >&2
    exit 1
  fi
else
  # Input is a plaintext token - hash it
  TOKEN_HASH=$(echo -n "$TOKEN_INPUT" | openssl dgst -sha256 -binary | xxd -p -c 256)
  if ! RESULT=$(echo "UPDATE api_key SET revoked_at = NOW() WHERE hash = :'token_hash' AND revoked_at IS NULL RETURNING id, account_id, revoked_at;" | psql "$COURIER_DATABASE_URL" -v token_hash="\\x$TOKEN_HASH" -t 2>&1); then
    echo "Error: Failed to revoke API token" >&2
    echo "$RESULT" >&2
    exit 1
  fi
fi

if [ -z "$(echo "$RESULT" | tr -d '[:space:]')" ]; then
  echo "Error: Token not found or already revoked" >&2
  exit 1
fi

echo "API token revoked successfully:"
echo "$RESULT" | sed 's/^/  /'
