# Build and publish courier Docker image to ECR.
#
# Triggers:
# - Push to main with changes to packages/courier, packages/clients, or packages/dashboard
# - Push of version tags (v*)
name: Publish Courier

on:
    # Path filtering only applies to branches, not tags.
    # - Main branch: triggers only when courier/clients/dashboard/docker paths change
    # - Version tags: always trigger (paths filter is ignored)
    push:
        branches: [main]
        paths:
            - "packages/courier/**"
            - "packages/clients/**"
            - "packages/dashboard/**"
            - "docker/courier/**"
        tags:
            - "v*"
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    AWS_REGION: us-west-1
    ECR_REPOSITORY: courier

jobs:
    build-and-push:
        name: Build and push courier image
        runs-on: ubuntu-latest-l
        permissions:
            contents: read
            id-token: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.ECR_ROLE }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              uses: aws-actions/amazon-ecr-login@v2

            - name: Generate image tag
              id: tag
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                    # For version tags, use the tag name (e.g., v1.2.3)
                    TAG="${{ github.ref_name }}"
                  else
                    # For main branch, use main-YYYYMMDDHHMMSS-SHA format
                    TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
                    SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
                    TAG="main-${TIMESTAMP}-${SHORT_SHA}"
                  fi
                  echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
                  echo "Generated tag: ${TAG}"

            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: docker/courier/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.tag.outputs.tag }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
