name: release

# Pushes releases on `vX.Y.Z` tags.
# Pushes prereleases on `vX.Y.Z-PRE.N` tags.
# Builds artifacts for PRs without creating releases.
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-[a-z]+.[0-9]+'
  pull_request:
    branches:
      - main

permissions:
  contents: write # Needed to write release contents

jobs:
  tagged:
    runs-on: ubuntu-latest

    outputs:
      sha: ${{ steps.compute.outputs.sha }}
      version: ${{ steps.compute.outputs.version }}
      release: ${{ steps.compute.outputs.release }}
      prerelease: ${{ steps.compute.outputs.prerelease }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
    - uses: actions/checkout@v4
      with:
          fetch-depth: 0

    - name: compute
      id: compute
      shell: bash
      run: |
        # On PRs, the git sha is not the same as the "triggering" sha:
        # https://github.com/orgs/community/discussions/26325
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          GITHUB_SHA="${{ github.event.pull_request.head.sha }}"
          SHA=$(git rev-parse --short $GITHUB_SHA)
        else
          SHA=$(git rev-parse --short HEAD)
        fi
        echo "sha=$SHA" >> "$GITHUB_OUTPUT"

        if [[ "${{ github.event_name }}" == "push" && "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]]; then
          # For tagged builds, use the tag with its `v` prefix stripped
          RELEASE="${GITHUB_REF#refs/tags/}"
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "release=$RELEASE" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Check if this is a prerelease tag (has pattern -[a-zA-Z]+[0-9]+)
          if [[ "$VERSION" =~ -[a-z]+\.[0-9]+ ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi
        else
          # For PR builds, use `0.0.0-{date}-{sha}` pseudotag
          DATE=$(date '+%Y-%m-%d')
          PSUEDOTAG="0.0.0-$DATE-$SHA"
          echo "release=v$PSUEDOTAG" >> "$GITHUB_OUTPUT"
          echo "version=$PSUEDOTAG" >> "$GITHUB_OUTPUT"
          echo "prerelease=true" >> "$GITHUB_OUTPUT"
        fi

    - name: changelog
      id: changelog
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          gh api repos/${{ github.repository }}/commits/${{ steps.compute.outputs.sha }} --jq '.commit.message | "- " + .' > version_changelog.txt
        else
          CURRENT_TAG="${{ steps.compute.outputs.release }}"

          # Get all tags sorted by version, excluding the current tag.
          ALL_TAGS=$(git tag -l 'v*' --sort=-version:refname | grep -v "^$CURRENT_TAG$")

          # Find the newest non-prerelease tag (doesn't match -[a-z]+\.[0-9]+).
          # `ALL_TAGS` is in descending order, sorted as versions; reference:
          # https://git-scm.com/docs/git-tag#Documentation/git-tag.txt---sortkey
          PREVIOUS_TAG=""
          for tag in $ALL_TAGS; do
            TAG_VERSION="${tag#v}"  # Remove 'v' prefix for pattern matching
            if [[ ! "$TAG_VERSION" =~ -[a-z]+\.[0-9]+$ ]]; then
              PREVIOUS_TAG="$tag"
              break
            fi
          done

          if [[ -n "$PREVIOUS_TAG" ]]; then
            echo "Changes since $PREVIOUS_TAG:" > version_changelog.txt
            echo "" >> version_changelog.txt
            gh api repos/${{ github.repository }}/compare/$PREVIOUS_TAG...$CURRENT_TAG --jq '.commits[] | .commit.message | "- " + .' >> version_changelog.txt
          else
            # If no previous non-prerelease tag found, get all commits
            echo "All changes:" > version_changelog.txt
            echo "" >> version_changelog.txt
            gh api repos/attunehq/hurry/commits --jq '.[] | .commit.message | "- " + .' >> version_changelog.txt
          fi
        fi
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        cat version_changelog.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: build / ${{ matrix.os }} / ${{ matrix.target }}
    needs: tagged
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native runners, no need for cross compilation
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
          - target: x86_64-apple-darwin
            os: macos-latest
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false

          # Cross compilation needed
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true

    steps:
      - uses: actions/checkout@v4
      - name: install rust
        run: |
          rustup toolchain install stable
          rustup target add ${{ matrix.target }}
          rustup show
      - name: install `cross`
        uses: taiki-e/install-action@v2
        if: matrix.cross
        with:
          tool: cross
      - name: install `cargo-set-version`
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-set-version

      - name: set version
        shell: bash
        run: cargo set-version ${{ needs.tagged.outputs.version }}

      - name: build
        shell: bash
        run: |
          CARGO_COMMAND=${{ matrix.cross && 'cross' || 'cargo' }}
          $CARGO_COMMAND build --release --target ${{ matrix.target }}

      - name: prepare
        shell: bash
        run: |
          TARGET_DIR="target/${{ matrix.target }}/release"
          ARTIFACT_NAME="hurry-${{ matrix.target }}"
          mkdir -p "$ARTIFACT_NAME"

          cp "$TARGET_DIR/hurry" "$ARTIFACT_NAME/"
          cp "$TARGET_DIR/hurry-cargo-rustc-wrapper" "$ARTIFACT_NAME/"
          cp README.md "$ARTIFACT_NAME/"
          tar -czf "$ARTIFACT_NAME.tar.gz" "$ARTIFACT_NAME"

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: hurry-${{ matrix.target }}
          path: hurry-${{ matrix.target }}.tar.gz
          if-no-files-found: warn

  create-checksums:
    name: checksums
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: generate
        run: |
          cd artifacts
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec sha256sum {} \; > checksums.txt
          cat checksums.txt

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: artifacts/checksums.txt

  release:
    name: push
    needs: [tagged, build, create-checksums]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: render
        shell: bash
        env:
          CHANGELOG: ${{ needs.tagged.outputs.changelog }}
        run: |
          # We echo this line over line instead of using the EOF syntax so that
          # we can avoid accidentally running "commands" that were inadvertently
          # in the changelog; the shell interprets backticks as commands to run
          # but commit messages routinely use them to refer to code.
          #
          # If we put the changelog into an env variable, and then echo the
          # variable directly, the variable is emitted as a string without
          # further interpolation:
          # ```
          # $ bash
          # bash-5.3$ export CONTENT='foo `bar` $(baz)'
          # bash-5.3$ echo $CONTENT
          # foo `bar` $(baz)
          # bash-5.3$ exit
          # exit
          # ```

          echo '## Changes in ${{ needs.tagged.outputs.release }}' > release.md
          echo '' >> release.md
          echo $CHANGELOG >> release.md
          echo '' >> release.md
          echo '## Installation' >> release.md
          echo '' >> release.md
          echo 'Download the appropriate binary for your system and architecture:' >> release.md
          echo '' >> release.md
          echo '| Platform | Architecture | Download |' >> release.md
          echo '| -------- | ------------ | -------- |' >> release.md
          echo '| macOS    | x86_64       | [hurry-x86_64-apple-darwin.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-x86_64-apple-darwin.tar.gz) |' >> release.md
          echo '| macOS    | arm64        | [hurry-aarch64-apple-darwin.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-aarch64-apple-darwin.tar.gz) |' >> release.md
          echo '| Linux    | x86_64       | [hurry-x86_64-unknown-linux-gnu.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-x86_64-unknown-linux-gnu.tar.gz) |' >> release.md
          echo '| Linux    | arm64        | [hurry-aarch64-unknown-linux-gnu.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-aarch64-unknown-linux-gnu.tar.gz) |' >> release.md
          echo '| Linux    | x86_64 (musl) | [hurry-x86_64-unknown-linux-musl.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-x86_64-unknown-linux-musl.tar.gz) |' >> release.md
          echo '| Linux    | arm64 (musl) | [hurry-aarch64-unknown-linux-musl.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-aarch64-unknown-linux-musl.tar.gz) |' >> release.md
          echo '' >> release.md
          echo 'See [checksums.txt](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/checksums.txt) for file checksums.' >> release.md

          echo 'release<<EOF' >> $GITHUB_OUTPUT
          cat release.md >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

          echo '## Release preview' >> $GITHUB_STEP_SUMMARY
          echo '> [!NOTE]' >> $GITHUB_STEP_SUMMARY
          echo '> The links in this preview will not download anything; they are provided for information only.' >> $GITHUB_STEP_SUMMARY
          echo '---' >> $GITHUB_STEP_SUMMARY
          cat release.md >> $GITHUB_STEP_SUMMARY
      - name: create
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/checksums.txt
          draft: false
          body: ${{ steps.render.outputs.release }}
          prerelease: ${{ needs.tagged.outputs.prerelease }}
