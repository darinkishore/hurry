name: "courier"
services:
    dev:
        build:
            context: .
            dockerfile: ./docker/dev/Dockerfile
        volumes:
            - .:/workspace
            - ~/.claude:/home/dev/.claude
            - ~/.claude.json:/home/dev/.claude.json
            - ~/.config/gh:/home/dev/.config/gh
            - ssh-data:/home/dev/.ssh
            - cargo-registry:/home/dev/.cargo/registry
            - cargo-git:/home/dev/.cargo/git
            - cargo-target:/workspace/target
            - zsh-history:/home/dev/.zsh_history_data
        working_dir: /workspace
        stdin_open: true
        tty: true
        env_file: ./.env
        environment:
            - SHELL=/bin/zsh
            - COURIER_DATABASE_URL=postgres://courier:courier@postgres:5432/courier
            - HURRY_COURIER_URL=https://courier.staging.corp.attunehq.com
            - HURRY_COURIER_URL_STAGING=https://courier.staging.corp.attunehq.com
            - HURRY_COURIER_URL_DOCKER=http://courier:3000
            - HURRY_COURIER_URL_LOCAL=http://host.docker.internal:3000
            - RUST_BACKTRACE=1
        extra_hosts:
            - "host.docker.internal:host-gateway"
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - dev

    courier:
        build:
            context: .
            dockerfile: ./docker/courier/Dockerfile
        ports:
            - "3000:3000"
        volumes:
            - .hurrydata/courier/cas:/data/cas
        env_file: ./.env
        environment:
            - COURIER_DATABASE_URL=postgres://courier:courier@postgres:5432/courier
            - CAS_ROOT=/data/cas
        command: ["serve"]
        depends_on:
            postgres:
                condition: service_healthy
            migrate:
                condition: service_completed_successfully
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/health"]
            interval: 1s
            timeout: 5s
        networks:
            - dev
        restart: on-failure

    postgres:
        image: postgres:18
        environment:
            - POSTGRES_USER=courier
            - POSTGRES_PASSWORD=courier
            - POSTGRES_DB=courier
        ports:
            - "5432:5432"
        volumes:
            - .hurrydata/postgres/data:/var/lib/postgresql/18/docker
        healthcheck:
            test: ["CMD", "pg_isready", "-U", "courier"]
            interval: 3s
            timeout: 2s
            retries: 5
        networks:
            - dev
        restart: on-failure

    migrate:
        build:
            context: .
            dockerfile: ./docker/courier/Dockerfile
        environment:
            - COURIER_DATABASE_URL=postgres://courier:courier@postgres:5432/courier
        command: ["migrate"]
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - dev
        restart: on-failure

volumes:
    cargo-registry:
    cargo-git:
    cargo-target:
    zsh-history:
    ssh-data:

networks:
    dev:
